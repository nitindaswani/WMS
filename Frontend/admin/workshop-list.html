<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshops - WMS Pro</title>
    <link rel="stylesheet" href="../public/css/variables.css">
    <link rel="stylesheet" href="../public/css/reset.css">
    <link rel="stylesheet" href="../public/css/layout.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/animations.css">
</head>

<body>

    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <div id="navbar"></div>

            <div class="section-header fade-in">
                <div>
                    <h1 class="page-title">Workshops Directory</h1>
                    <p class="page-subtitle">Manage all your scheduled and past workshops.</p>
                </div>
                <button class="btn btn-primary" onclick="window.location.href='create-workshop.html'">+ New
                    Workshop</button>
            </div>

            <!-- Filters -->
            <div
                class="card style='margin-bottom: 24px; padding: 16px; display: flex; gap: 12px; align-items: center;' class='fade-in' style='animation-delay: 0.1s;'">
                <input type="text" class="form-input" placeholder="Search workshops..." style="max-width: 300px;">
                <select class="form-input" style="max-width: 150px;">
                    <option>All Status</option>
                    <option>Active</option>
                    <option>Completed</option>
                    <option>Draft</option>
                </select>
                <div style="margin-left: auto; color: var(--text-muted); font-size: 0.9rem;">Showing 12 results</div>
            </div>

            <!-- Table -->
            <div class="card fade-in" style="animation-delay: 0.2s;">
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Workshop Name</th>
                                <th>Date</th>
                                <th>Instructor</th>
                                <!-- <th>Capacity</th> -->
                                <!-- Backend doesn't send seat usage count in list yet without optimization, we'll verify -->
                                <th>Category</th>
                                <th>Status</th>
                                <th>Budget</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="workshopTableBody">
                            <tr>
                                <td colspan="6" style="text-align:center;">Loading workshops...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <script src="../public/js/config.js"></script>
    <script src="../public/js/auth.js"></script>
    <script src="../public/js/dom.js"></script>
    <script>
        if (!Auth.isAuthenticated() || Auth.getRole() !== 'admin') window.location.href = 'login.html';

        async function loadWorkshops() {
            try {
                const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/workshops/`);
                if (res.ok) {
                    const workshops = await res.json();
                    renderTable(workshops);
                } else {
                    document.getElementById('workshopTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--danger);">Failed to load workshops</td></tr>';
                }
            } catch (error) {
                console.error(error);
                document.getElementById('workshopTableBody').innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--danger);">Network error</td></tr>';
            }
        }

        function renderTable(workshops) {
            const tbody = document.getElementById('workshopTableBody');
            tbody.innerHTML = '';

            if (workshops.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: var(--text-muted);">No workshops found. Create one!</td></tr>';
                return;
            }

            workshops.forEach(w => {
                const tr = document.createElement('tr');
                // Determine Status
                const today = new Date().toISOString().split('T')[0];
                let badgeClass = 'badge-primary';
                let statusText = 'Upcoming';
                if (w.start_date <= today && w.end_date >= today) {
                    badgeClass = 'badge-success';
                    statusText = 'Live';
                } else if (w.end_date < today) {
                    badgeClass = 'badge-secondary'; // or basic
                    statusText = 'Completed';
                }

                tr.innerHTML = `
                    <td style="font-weight: 600; color: var(--text-highlight);">${w.title}</td>
                    <td>${w.start_date}</td>
                    <td>${w.speaker ? 'Speaker Assigned' : 'No Speaker'}</td> <!-- Can be improved if we fetch speaker details or if API returns name -->
                    <td>${w.category}</td>
                    <td><span class="badge ${badgeClass}">${statusText}</span></td>
                    <td>$${w.budget}</td>
                    <td>
                        <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem;"
                            onclick="window.location.href='workshop-details.html?id=${w.id}'">Manage</button>
                            <button class="btn btn-outline" style="padding: 6px 12px; font-size: 0.8rem; color: var(--danger); border-color: var(--danger);"
                            onclick="deleteWorkshop(${w.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function deleteWorkshop(id) {
            if (!confirm('Are you sure you want to delete this workshop?')) return;
            try {
                const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/workshops/${id}/`, {
                    method: 'DELETE'
                });
                if (res.status === 204) {
                    loadWorkshops();
                } else {
                    alert('Failed to delete');
                }
            } catch (e) {
                console.error(e);
            }
        }

        loadWorkshops();
    </script>
</body>

</html>