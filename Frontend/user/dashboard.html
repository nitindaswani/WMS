<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - WMS Portal</title>
    <link rel="stylesheet" href="../public/css/variables.css">
    <link rel="stylesheet" href="../public/css/reset.css">
    <link rel="stylesheet" href="../public/css/layout.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/animations.css">
    <link rel="stylesheet" href="../public/css/loader.css">
    <link rel="stylesheet" href="../public/css/toast.css">
    <style>
        .banner {
            background: linear-gradient(90deg, #3A7BFF 0%, #9D4BFF 100%);
            border-radius: var(--radius-lg);
            padding: 32px;
            color: white;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <!-- Navbar -->
            <div id="navbar"></div>

            <!-- Welcome Banner -->
            <div class="banner fade-in">
                <div>
                    <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 8px;">Welcome back, <span
                            id="user-welcome-name" class="skeleton skeleton-text"
                            style="display:inline-block; width: 150px;"></span>!</h1>
                    <p style="opacity: 0.9;" id="banner-msg">Loading your schedule...</p>
                </div>
                <img src="https://cdni.iconscout.com/illustration/premium/thumb/coding-3462274-2895956.png"
                    alt="Learning" style="height: 120px; display: none; @media(min-width: 768px){display: block;}">
            </div>

            <!-- Quick Stats -->
            <section class="grid-3 stagger-children">
                <div class="card stat-card float-hover">
                    <div class="stat-value" id="stat-attended">
                        <div class="skeleton skeleton-text" style="width: 50px; height: 40px;"></div>
                    </div>
                    <div class="stat-label">Workshops Attended</div>
                </div>
                <div class="card stat-card float-hover">
                    <div class="stat-value" id="stat-certificates">
                        <div class="skeleton skeleton-text" style="width: 50px; height: 40px;"></div>
                    </div>
                    <div class="stat-label">Certificates Earned</div>
                </div>
                <div class="card stat-card float-hover">
                    <div class="stat-value">12h</div>
                    <div class="stat-label">Learning Time</div>
                </div>
            </section>

            <!-- Upcoming Registrations -->
            <section class="fade-in" style="margin-top: 32px; animation-delay: 0.3s;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2 style="font-size: 1.25rem; font-weight: 600;">Upcoming Workshops</h2>
                    <a href="my-registrations.html" style="color: var(--primary);">View All</a>
                </div>

                <div class="grid-2" id="upcoming-grid">
                    <!-- Skeletons -->
                    <div class="card skeleton skeleton-card"></div>
                    <div class="card skeleton skeleton-card"></div>
                </div>
            </section>

        </main>
    </div>

    <!-- Scripts -->
    <script src="../public/js/config.js?v=1.1"></script>
    <script src="../public/js/auth.js?v=1.1"></script>
    <script src="../public/js/dom.js"></script>
    <script src="../public/js/components.js"></script>
    <script src="../public/js/toast.js"></script>

    <script>
        async function initPage() {
            try {
                // 1. Load Layout Components using new Component Loader
                await Promise.all([
                    Components.load('sidebar', '/components/user-sidebar.html'),
                    Components.load('navbar', '/components/user-navbar.html')
                ]);

                // 2. Load User Data
                await loadUserProfile();

                // 3. Load Dashboard Stats
                loadDashboardStats();

            } catch (error) {
                console.error("Page Init Error:", error);
                Toast.error("Failed to initialize dashboard. Please refresh.");
            }
        }

        async function loadUserProfile() {
            let userName = localStorage.getItem('user_full_name');
            const displayEl = document.getElementById('user-welcome-name');

            if (!userName || userName === 'Student') {
                try {
                    const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/auth/user/`);
                    if (res.ok) {
                        const data = await res.json();
                        userName = data.full_name || 'Student';
                        localStorage.setItem('user_full_name', userName);
                    }
                } catch (e) {
                    console.warn("Failed to fetch user profile, using fallback.");
                }
            }

            // Update UI & Remove Skeleton
            userName = userName || 'Student';
            displayEl.innerText = userName;
            displayEl.classList.remove('skeleton', 'skeleton-text');
            displayEl.style.width = 'auto'; // Reset width

            // Update Navbar specifics if available
            if (document.getElementById('nav-user-name')) {
                document.getElementById('nav-user-name').innerText = userName;
                const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const avatar = document.querySelector('.user-avatar');
                if (avatar) avatar.innerText = initials;
            }
        }

        async function loadDashboardStats() {
            try {
                const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/workshops/analytics/`);

                if (res.ok) {
                    const data = await res.json();

                    // Update Stats
                    document.getElementById('stat-attended').innerText = data.total_registrations || 0;
                    document.getElementById('stat-certificates').innerText = data.certificates || 0;

                    // Render Upcoming
                    renderUpcomingWorkshops(data.upcoming_workshops || []);

                } else {
                    throw new Error("API returned " + res.status);
                }
            } catch (e) {
                console.error("Dashboard Load Error:", e);
                // Graceful error state
                document.getElementById('upcoming-grid').innerHTML = `
                    <div style="grid-column:1/-1; padding:20px; border:1px dashed var(--border-color); border-radius:8px; text-align:center;">
                        <p style="color:var(--text-muted)">Could not load workshops.</p>
                        <button onclick="loadDashboardStats()" class="btn btn-sm btn-outline" style="margin-top:10px">Retry</button>
                    </div>
                `;
                Toast.warning("Could not refresh dashboard data.");
            }
        }

        function renderUpcomingWorkshops(workshops) {
            const container = document.getElementById('upcoming-grid');
            container.innerHTML = ''; // Clear skeletons

            // Update Banner Message
            const bannerMsg = document.getElementById('banner-msg');
            if (workshops.length > 0) {
                bannerMsg.innerText = `You have ${workshops.length} upcoming workshops this week.`;
            } else {
                bannerMsg.innerText = `No upcoming workshops scheduled.`;
            }

            if (workshops.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted); background: rgba(255,255,255,0.02); border-radius: 12px;">
                        <p>No upcoming workshops found.</p>
                        <a href="workshops.html" class="btn btn-primary" style="margin-top:16px;">Browse Workshops</a>
                    </div>`;
                return;
            }

            workshops.forEach(w => {
                const date = new Date(w.start_date);
                const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                const div = document.createElement('div');
                div.className = 'card float-hover';
                div.onclick = () => window.location.href = `workshop-details.html?id=${w.id}`;
                div.style.cursor = 'pointer';
                div.innerHTML = `
                    <div style="display:flex;justify-content:space-between; align-items: flex-start;">
                        <div>
                        <h4 style="font-size: 0.95rem; font-weight: 600; color: var(--text-highlight); margin-bottom: 4px;">${escapeHTML(w.title)}</h4>
                        <span class="badge badge-sm" style="background: rgba(255,255,255,0.1); color: var(--text-muted); padding: 2px 8px; font-size: 0.75rem;">${escapeHTML(w.category || 'Workshop')}</span>
                    </div>
                        <span class="badge badge-success">Registered</span>
                    </div>
                    <div style="margin-top: 16px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-muted);">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
                            ${w.location || 'Online'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // Start
        initPage();
    </script>
</body>

</html>