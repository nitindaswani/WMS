<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop Details - WMS Portal</title>
    <link rel="stylesheet" href="../public/css/variables.css">
    <link rel="stylesheet" href="../public/css/reset.css">
    <link rel="stylesheet" href="../public/css/layout.css">
    <link rel="stylesheet" href="../public/css/components.css">
    <link rel="stylesheet" href="../public/css/animations.css">
</head>

<body>

    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <div id="navbar"></div>

            <div class="fade-in">
                <a href="workshops.html"
                    style="color: var(--text-muted); display: flex; align-items: center; gap: 6px; margin-bottom: 24px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back to Workshops
                </a>

                <div class="card" style="padding: 0; overflow: hidden;">
                    <!-- Cover Image Placeholder -->
                    <div
                        style="height: 200px; background: linear-gradient(135deg, #3A7BFF, #2962FF); display: flex; align-items: center; justify-content: center;">
                        <h1 style="font-size: 3rem; color: rgba(255,255,255,0.2); font-weight: 800;">REACT</h1>
                    </div>

                    <div style="padding: 32px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
                            <div>
                                <h1 style="font-size: 2rem; font-weight: 700; margin-bottom: 8px;">Modern React Patterns
                                </h1>
                                <p style="color: var(--text-muted);">Instructor: <span
                                        style="color: var(--primary);">Dr. Angela Yu</span></p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 1.5rem; font-weight: 700; color: var(--teal);">$49.99</div>
                                <span class="badge badge-success">Open for Registration</span>
                            </div>
                        </div>

                        <div class="grid-3" style="margin-bottom: 32px; gap: 16px;">
                            <div
                                style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: var(--radius-md);">
                                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 4px;">Date &
                                    Time</div>
                                <div style="font-weight: 600;">Oct 12, 10:00 AM</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: var(--radius-md);">
                                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 4px;">Duration
                                </div>
                                <div style="font-weight: 600;">6 Hours</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: var(--radius-md);">
                                <div style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 4px;">Location
                                </div>
                                <div style="font-weight: 600;">Main Hall A</div>
                            </div>
                        </div>

                        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 12px;">About this Workshop</h2>
                        <p style="color: var(--text-main); line-height: 1.6; max-width: 800px; margin-bottom: 32px;">
                            Join us for an intensive deep dive into modern React development. We will cover server
                            components, suspense, concurrent mode, and advanced state management patterns. Perfect for
                            developers looking to upgrade their skills to React 19.
                        </p>

                        <div style="display: flex; gap: 16px;">
                            <button class="btn btn-primary pulse-glow"
                                onclick="alert('Proceeding to payment...')">Register as Student</button>
                            <button class="btn btn-outline" style="border-color: var(--accent); color: var(--accent);"
                                onclick="alert('Request sent to admin.')">Apply as Guest Speaker</button>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script src="../public/js/config.js"></script>
    <script src="../public/js/auth.js"></script>
    <script src="../public/js/dom.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const workshopId = urlParams.get('id');

        async function loadData() {
            if (!workshopId) {
                alert("Invalid Workshop ID");
                window.location.href = 'workshops.html';
                return;
            }

            try {
                // Fetch Workshop Details
                const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/workshops/${workshopId}/`);
                if (res.ok) {
                    const workshop = await res.json();
                    renderWorkshop(workshop);
                } else {
                    document.querySelector('.main-content').innerHTML = '<div style="padding:40px;text-align:center;">Workshop not found</div>';
                }
            } catch (e) {
                console.error(e);
            }
        }

        function renderWorkshop(w) {
            // Header Image
            // If we had images: document.getElementById('cover-image').src = w.image_url;

            // Title & Info
            // The first H1 is inside the banner, which is static. The second H1 is the workshop title.
            // Using refined selectors based on current DOM structure:
            const contentDiv = document.querySelector('.card > div:nth-child(2)');
            contentDiv.querySelector('h1').innerText = escapeHTML(w.title);
            contentDiv.querySelector('p span').innerText = escapeHTML(w.category || 'General'); // Replaced Instructor with Category for now

            // We can check if user is already registered? Backend usually handles 400 "Already registered".

            const price = w.price > 0 ? `$${escapeHTML(String(w.price))}` : 'Free';
            contentDiv.querySelector('div[style*="text-align: right"] div').innerText = price;

            // Date
            const dateStr = escapeHTML(new Date(w.start_date).toLocaleString('en-US', { dateStyle: 'medium', timeStyle: 'short' }));

            // Stats Grid
            const grids = document.querySelectorAll('.grid-3 > div');
            if (grids.length >= 3) {
                grids[0].querySelector('div:last-child').innerText = dateStr;
                grids[1].querySelector('div:last-child').innerText = 'Online/TBD'; // Duration/Loc placeholder
                grids[2].querySelector('div:last-child').innerText = 'Open'; // Status
            }

            // Description
            const aboutSection = document.querySelector('h2').nextElementSibling;
            aboutSection.innerText = w.description || 'No description provided.';

            // Register Button
            const btn = document.querySelector('.btn-primary');
            btn.onclick = () => registerForWorkshop(w.id);
            btn.innerText = 'Register Now'; // Reset text
        }

        async function registerForWorkshop(id) {
            if (!confirm("Confirm registration for this workshop?")) return;

            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = 'Registering...';
            btn.disabled = true;

            try {
                // Get Role to determine URL part
                const role = Auth.getRole() || 'student';

                // FIXED URL: Added /student/ (or role) at the end
                const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/workshops/${id}/register/${role}/`, {
                    method: 'POST'
                });

                if (res.ok) {
                    alert("Successfully Registered!");
                    window.location.href = 'my-registrations.html';
                } else {
                    const err = await res.json();
                    alert("Registration Failed: " + (err.error || JSON.stringify(err)));
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert("Network Error: Could not reach server.");
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function loadComponents() {
            const sidebarRes = await fetch('/components/user-sidebar.html');
            document.getElementById('sidebar').innerHTML = await sidebarRes.text();

            const navbarRes = await fetch('/components/user-navbar.html');
            document.getElementById('navbar').innerHTML = await navbarRes.text();

            // Update Navbar
            const userName = localStorage.getItem('user_full_name') || 'Student';
            const userRole = localStorage.getItem('auth_role') || 'student';
            if (document.getElementById('nav-user-name')) document.getElementById('nav-user-name').innerText = userName;
            if (document.getElementById('nav-user-role')) document.getElementById('nav-user-role').innerText = userRole.charAt(0).toUpperCase() + userRole.slice(1);

            loadData();
        }
        loadComponents();
    </script>
</body>

</html>