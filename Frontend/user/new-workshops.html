<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Workshops - WMS Student</title>
    <link rel="stylesheet" href="/public/css/variables.css">
    <link rel="stylesheet" href="/public/css/reset.css">
    <link rel="stylesheet" href="/public/css/layout.css">
    <link rel="stylesheet" href="/public/css/components.css">
    <link rel="stylesheet" href="/public/css/animations.css">
</head>

<body>

    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <div id="navbar"></div>

            <div class="section-header fade-in">
                <div>
                    <h1 class="page-title">Explore Workshops</h1>
                    <p class="page-subtitle">Discover and register for new learning opportunities.</p>
                </div>
                <div style="display: flex; gap: 12px;">
                    <select class="form-input" style="width: 180px;">
                        <option>All Categories</option>
                        <option>Frontend</option>
                        <option>Backend</option>
                        <option>Design</option>
                    </select>
                </div>
            </div>

            <!-- New Workshops Grid -->
            <div id="workshops-grid" class="grid-3 stagger-children">
                <p style="color: var(--text-muted);">Loading workshops...</p>
            </div>

        </main>
    </div>

    <script src="/public/js/config.js"></script>
    <script src="/public/js/auth.js"></script>
    <script src="/public/js/dom.js"></script>
    <script>
        if (!Auth.isAuthenticated()) window.location.href = '/user/login.html';

        async function init() {
            // Load Workshops & Registrations parallel
            try {
                const [wsRes, regRes] = await Promise.all([
                    Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/workshops/`),
                    Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/user/registrations/`)
                ]);

                if (wsRes.ok && regRes.ok) {
                    const workshops = await wsRes.json();
                    const registrations = await regRes.json();

                    const registeredIds = new Set(registrations.map(r => r.workshop.id));

                    // Filter: Only show workshops NOT in registeredIds
                    const newWorkshops = workshops.filter(w => !registeredIds.has(w.id));

                    renderWorkshops(newWorkshops);
                } else {
                    document.getElementById('workshops-grid').innerHTML = '<p>Error loading data.</p>';
                }
            } catch (e) {
                console.error(e);
                document.getElementById('workshops-grid').innerHTML = '<p>Network Error.</p>';
            }
        }

        function renderWorkshops(workshops) {
            const grid = document.getElementById('workshops-grid');
            grid.innerHTML = '';

            if (workshops.length === 0) {
                grid.innerHTML = '<p style="color: var(--text-muted); grid-column: 1/-1;">No new workshops available. You are registered for everything!</p>';
                return;
            }

            workshops.forEach(w => {
                const div = document.createElement('div');
                div.className = 'card float-hover';
                div.innerHTML = `
                    <div style="height: 160px; background: linear-gradient(135deg, ${getRandomColor()}, ${getRandomColor()}); border-radius: 12px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; position: relative;">
                         ${isNew(w.created_at) ? '<span class="badge badge-primary" style="position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.5);">New</span>' : ''}
                        <h3 style="font-size: 1.5rem; font-weight: 800; color: white; text-align:center; padding:10px;">${w.topic || 'Workshop'}</h3>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <div>
                            <span class="badge" style="background:var(--bg-secondary); color:var(--text-muted); font-size:0.7rem; margin-bottom:8px; display:inline-block;">${w.category || 'General'}</span>
                             <h3 class="card-title" style="margin-bottom: 8px;">${w.title}</h3>
                        </div>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.95rem; line-height: 1.5; margin-bottom: 20px; flex-grow: 1;">
                        ${w.description ? w.description.substring(0, 80) + '...' : 'No description'}
                    </p>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; font-size: 0.9rem; color: var(--text-muted);">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            ${w.start_date || 'TBA'}
                        </div>
                        <div style="font-weight: 700; color: var(--teal); font-size: 1.1rem;">$${w.budget || 'Free'}</div>
                    </div>

                    <a href="workshop-details.html?id=${w.id}" class="btn btn-primary" style="width: 100%;">Register Now</a>
                `;
                grid.appendChild(div);
            });
        }

        function getRandomColor() {
            const colors = ['#2563ea', '#db2777', '#059669', '#d97706', '#7c3aed'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function isNew(dateString) {
            // Simple check if created in last 7 days
            if (!dateString) return false;
            const created = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - created);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7;
        }

        init();
    </script>
</body>

</html>