<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Schedule - WMS Portal</title>
    <link rel="stylesheet" href="/public/css/variables.css">
    <link rel="stylesheet" href="/public/css/reset.css">
    <link rel="stylesheet" href="/public/css/layout.css">
    <link rel="stylesheet" href="/public/css/components.css">
    <link rel="stylesheet" href="/public/css/animations.css">
</head>

<body>

    <div class="app-container">
        <aside class="sidebar" id="sidebar"></aside>

        <main class="main-content">
            <div id="navbar"></div>

            <div class="section-header fade-in">
                <div>
                    <h1 class="page-title">My Schedule</h1>
                    <p class="page-subtitle">View sessions for your registered workshops.</p>
                </div>
            </div>

            <!-- Step 1: Select Workshop -->
            <div class="card fade-in">
                <div class="form-group">
                    <label class="form-label">Select Workshop</label>
                    <select id="workshopSelect" class="form-input" onchange="loadSessions(this.value)">
                        <option value="">Select a workshop to view sessions...</option>
                    </select>
                </div>
            </div>

            <!-- Step 2: Sessions List -->
            <div id="sessions-container" class="fade-in"
                style="margin-top: 24px; animation-delay: 0.1s; display: none;">
                <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 16px;">Sessions Schedule</h2>
                <div id="sessions-grid" class="grid-1" style="gap: 16px;">
                    <!-- Sessions will be loaded here -->
                </div>
            </div>

        </main>
    </div>

    <script src="/public/js/config.js"></script>
    <script src="/public/js/auth.js"></script>
    <script src="/public/js/dom.js"></script>
    <script>
        if (!Auth.isAuthenticated()) window.location.href = '/user/login.html';

        async function init() {
            await loadComponents();
            await loadUserWorkshops();
        }
        init();

        async function loadUserWorkshops() {
            try {
                const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/user/registrations/`);
                if (res.ok) {
                    const registrations = await res.json();
                    const select = document.getElementById('workshopSelect');

                    if (registrations.length === 0) {
                        select.innerHTML = '<option value="">No registered workshops found</option>';
                        return;
                    }

                    registrations.forEach(reg => {
                        const opt = document.createElement('option');
                        opt.value = reg.workshop.id;
                        opt.textContent = reg.workshop.title;
                        select.appendChild(opt);
                    });

                    // Auto select first one
                    if (registrations.length > 0) {
                        select.value = registrations[0].workshop.id;
                        loadSessions(registrations[0].workshop.id);
                    }
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadSessions(workshopId) {
            if (!workshopId) {
                document.getElementById('sessions-container').style.display = 'none';
                return;
            }

            document.getElementById('sessions-container').style.display = 'block';
            const grid = document.getElementById('sessions-grid');
            grid.innerHTML = '<div style="color:var(--text-muted);">Loading sessions...</div>';

            try {
                const res = await Auth.authenticatedFetch(`${CONFIG.API_BASE_URL}/workshops/${workshopId}/sessions/`);
                if (res.ok) {
                    const sessions = await res.json();
                    grid.innerHTML = '';

                    if (sessions.length === 0) {
                        grid.innerHTML = '<div style="padding: 16px; background: rgba(255,255,255,0.05); border-radius: 8px;">No sessions found for this workshop.</div>';
                        return;
                    }

                    sessions.forEach(session => {
                        const div = document.createElement('div');
                        div.className = 'card float-hover';
                        div.style.padding = '20px';
                        div.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div>
                                    <h3 style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; color: var(--text-highlight);">${session.session_title}</h3>
                                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 12px;">${session.description || 'No description'}</p>
                                    <div style="display: flex; gap: 16px; font-size: 0.85rem; color: var(--text-muted);">
                                        <span style="display: flex; align-items: center; gap: 6px;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                                            ${session.start_time} - ${session.end_time}
                                        </span>
                                        <span style="display: flex; align-items: center; gap: 6px;">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                            ${session.day_of_week || 'TBA'}
                                        </span>
                                        <span class="badge ${session.mode === 'online' ? 'badge-primary' : 'badge-success'}">${session.mode}</span>
                                    </div>
                                </div>
                                <div>
                                    <!-- Future: Add to Cal checkbox -->
                                </div>
                            </div>
                        `;
                        grid.appendChild(div);
                    });
                }
            } catch (e) {
                grid.innerHTML = 'Error loading sessions';
                console.error(e);
            }
        }
    </script>

</body>

</html>